<?php

namespace app\models;

use Yii;
use yii\base\Model;
use yii\db\Connection;
use yii\web\Response;
use yii\web\JsExpression;
use yii\web\Session;
use yii\web\Cookie;

class RtScheduledMethods extends Model
{
    /**
     * @param string $dbName
     *
     * @return Connection
     */
    public function connectDb($dbName)
    {
        return Yii::$app->$dbName;
    }

    public function ArrayObjectFormat($inputArray)
    {

        return $inputArray = (object)$inputArray;

    }


    /**
     * @param $inputElement
     * @return string
     */
    public function CookieElementEncrypt($inputElement)
    {
        $iv = mcrypt_create_iv(mcrypt_get_iv_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC), MCRYPT_DEV_URANDOM);

        $EncryptedValue = base64_encode(
            $iv .
            mcrypt_encrypt(
                MCRYPT_RIJNDAEL_128,
                hash('sha256', COOKIE_ELEMENT_ENCRYPT_KEY, true),
                $inputElement,
                MCRYPT_MODE_CBC,
                $iv
            )
        );

        return $EncryptedValue;

    }


    /**
     * @param $inputElement
     * @return string
     */
    public function CookieElementDecrypt($inputElement)
    {
        $data = base64_decode($inputElement);
        if (!empty($data)) {
            $iv = substr($data, 0, mcrypt_get_iv_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC));

            $DecryptedValue = rtrim(
                mcrypt_decrypt(
                    MCRYPT_RIJNDAEL_128,
                    hash('sha256', COOKIE_ELEMENT_ENCRYPT_KEY, true),
                    substr($data, mcrypt_get_iv_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC)),
                    MCRYPT_MODE_CBC,
                    $iv
                ),
                "\0"
            );
        } else {
            $DecryptedValue = '';
        }

        return $DecryptedValue;

    }


    public function fnRequestReviewEmailSent()
	{
		$RtConnDb = RtScheduledMethods::connectDb('rotitime');
        $fetchQuery = "SELECT * FROM rt_restaurant_orders WHERE ordered_at > DATE_SUB(NOW(), INTERVAL '2' HOUR)";
		$queryResult = $RtConnDb
        ->createCommand($fetchQuery)
		->queryAll();

        return $queryResult;
    }

	public function fnUpdateRequestReviewEmailSent()
	{		
		$RtConnDb = RtScheduledMethods::connectDb('rotitime');
		$fetchQuery = "update rt_restaurant_orders set `is_request_for_review_email_sent`='Y' WHERE DATE_ADD(now(), INTERVAL 2 HOUR)";
		$queryResult = $RtConnDb
		->createCommand($fetchQuery)
		->queryAll();

		return $queryResult;	
    }	

}